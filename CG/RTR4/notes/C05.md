#  C05. 着色基础 Shading Basics

[TOC]

## 5.1 着色模型 Shading Models

决定物体外观的第一步是选择着色模型。

着色模型描述了物体的颜色与一些因素（法向，视线方向，光照）的关系。

Gooch 着色模型是一种非真实渲染形式，设计于增加技术插图中的细节辨识度。基本思想是比较表面法向和光源位置，如果法向指向光源，则使用暖色调，否则用冷色调。

着色模型经常有用于控制外观变化的属性，这是决定物体外观的第二步。Gooch 着色模型只有一个属性——表面颜色。

> 示例
>
> ![1559821511650](assets/1559821511650.png)

Gooch 着色模型收到表面朝向，视线方向和光线方向的影响，一般用单位向量描述

![1559822070325](assets/1559822070325.png)

着色公式为
$$
\mathbf { c } _ { \text { shaded } } = s \mathbf { c } _ { \text { highlight } } + ( 1 - s ) \left( t \mathbf { c } _ { \text { warm } } + ( 1 - t ) \mathbf { c } _ { \text { cool } } \right)
$$
其中
$$
\begin{aligned} \mathbf { c } _ { \mathrm { cool } } & = ( 0,0,0.55 ) + 0.25 \mathbf { c } _ { \mathrm { surface } } \\ \mathbf { c } _ { \mathrm { warm } } & = ( 0.3,0.3,0 ) + 0.25 \mathbf { c } _ { \mathrm { surface } } \\ \mathbf { c } _ { \mathrm { highight } } & = ( 1,1,1 ) \\ t & = \frac { ( \mathbf { n } \cdot \mathbf { l } ) + 1 } { 2 } \\ \mathbf { r } & = 2 ( \mathbf { n } \cdot \mathbf { l } ) \mathbf { n } - \mathbf { l } \\ s & = ( 100 ( \mathbf { r } \cdot \mathbf { v } ) - 97 ) ^ { \mp } \end{aligned}
$$
只有 $\mathbf{c}_\text{surface}$ 是可以控制的属性。

这些公式中包含一些常见操作

- $\mp$ 指 clamp 到 0 和 1
- 单位向量的点乘
- 线性插值
- 反射，如 $\mathbf { r } = 2 ( \mathbf { n } \cdot \mathbf { l } ) \mathbf { n } - \mathbf { l }$ 

## 5.2 光源 Light Sources

一个常见的着色模型会划分 lit 和 unlit 部分
$$
\mathbf { c } _ { \text {shaded} } = f _ { \text {unlit} } ( \mathbf { n } , \mathbf { v } ) + \sum _ { i = 1 } ^ { n } \mathbf { c } _ { \text {light} _ { i } } f _ { \text {lit} } \left( \mathbf { l } _ { i } , \mathbf { n } , \mathbf { v } \right) \tag{1}
$$
$f_\text{unlit}$ 有多种形式，取决于需求。如 $f_{unlit}()=(0,0,0)$。这部分经常用于表达不是直接来自光源的光照效果。

光对表面的影响可以被可视化为一组光线，光照强度与光线照射到表面的密度相对应。

![1559827324994](assets/1559827324994.png)

击中表面的光线间隔与 $\cos\theta$ 成反比，当 $\cos\theta$ 为负时，光从表面的背面过来，没有影响。因此有
$$
\mathbf { c } _ { \text {shaded} } = f _ { \text {unlit} } ( \mathbf { n } , \mathbf { v } ) + \sum _ { i = 1 } ^ { n } \left( \mathbf { l } _ { i } \cdot \mathbf { n } \right) ^ { + } \mathbf { c } _ { \text {light} _ { i } } f _ { \text {lit} } \left( 1 _ { i } , \mathbf { n } , \mathbf { v } \right) \tag{2}
$$
式 (1) 更泛化些，式 (2) 适合于基于物理的模型。

最简单的 $f_\text{lit}$ 是 $f _ { \text {lit} } ( ) = \mathbf { c } _ { \text {surface} }$，则有
$$
\mathbf{c}_{\text { shaded }}=f_{\text { unlit }}(\mathbf{n}, \mathbf{v})+\sum_{i=1}^{n}\left(\mathbf{l}_{i} \cdot \mathbf{n}\right)^{+} \mathbf{c}_{\text { light }_{i}} \mathbf{c}_{\text { surface }}
$$
这个渲染模型就是 Lambertian 着色模型，适用于理想漫反射表面。

式 (1) 和式 (2) 中光源与着色模型的关联只有 $\mathbf{l}$ 和 $\mathbf{c}_\text{light}$。

接下来会介绍几种光源，他们的共性是对表面的一个位置，只有一个光源方向 $\mathbf{l}$。

### 5.2.1 方向光 Directional Lights

方向光是光源中最简单的一个模型，有如下性质

- $\mathbf{l}$ 和 $\mathbf{c}_\text{light}$ 在场景中保持常量
- $\mathbf{c}_\text{light}$ 可能因为阴影而衰减
- 没有位置

### 5.2.2 Punctual Lights

Punctual light 是有位置的光源，没有形状和大小。Punctual 来源于拉丁语 punctus，意思是“点”。点光源 point light 指代一种光源，它朝向所有方向发出相同的光。为做区分而用了 punctual。

记光源位置为 $\mathbf{p}_\text{light}$，表面点位置为 $\mathbf{p}_0$，则光源方向为
$$
1=\frac{\mathbf{p}_{\text { light }}-\mathbf{p}_{0}}{\left\|\mathbf{p}_{\text { light }}-\mathbf{p}_{0}\right\|}
$$
上述用了向量标准化 vector normalization。有时向量的长度是有用的，因此可以将上述操作改为更基本的操作
$$
\begin{aligned} \mathbf{d} &=\mathbf{p}_{\text { light }}-\mathbf{p}_{0} \\ r &=\sqrt{\mathbf{d} \cdot \mathbf{d}} \\ 1 &=\frac{\mathrm{d}}{r} \end{aligned}
$$
中间结果 $r$ 是光源与表面点的距离，常用于计算 $\mathbf{c}_\text{light}$ 的衰减。

#### 点/全向光源 Point/Omni Lights

在所有方向均匀发光的 punctual light 是点光源 point light 或全向光源 omni light。

对于点光源，$\mathbf{c}_\text{light}$ 会随着距离衰减，与距离的平方成反比。

我们可以定义 $\mathbf{c}_\text{light}(r_0)=\mathbf{c}_{\text{light}_0}$。则有
$$
\mathbf{c}_{\text { light }}(r)=\mathbf{c}_{\text { light }_{0}}\left(\frac{r_{0}}{r}\right)^{2}
$$
上式长称为 inverse-square light attenuation。当 r 趋向 0 时，$\mathbf{c}_\text{light}$ 趋向无穷。

为避免这个问题，一个场景的修改是在分母处添加一个小值
$$
\mathbf{c}_{\text { light }}(r)=\mathbf{c}_{\text { light }_{0}} \frac{r_{0}^{2}}{r^{2}+\epsilon}
$$
具体的 $\epsilon$ 取决于应用，如 Unreal 将其设置为 1 cm。

还有其他修改方式，如 CryEngine 和 Frostbite 用 clamp
$$
\mathbf{c}_{\text { light }}(r)=\mathbf{c}_{\text { light }_{0}}\left(\frac{r_{0}}{\max \left(r, r_{\text { min }}\right)}\right)^{2}
$$
$r_\text{min}$ 具有物理解释，指代光源的半径。

另一方面，inverse-square attenuation 即使很远，光强也不会为 0。为了高效渲染，我们会使其在有限的距离到达 0。有很多方法可以做到这点。一种解决方案是将其成语一个窗口函数 windowing function。Unreal 和 Frostbite 用的窗口函数如下
$$
f_{\mathrm{win}}(r)=\left(1-\left(\frac{r}{r_{\mathrm{max}}}\right)^{4}\right)^{+2}
$$
其中 $+2$ 是在平方前将复数 clamp 为 0。

![1559830615739](assets/1559830615739.png)

一些应用中不优先考虑匹配 inverse-square 曲线，而会有其他函数。因此更加泛化的公式为
$$
\mathbf{c}_{\text { light }}(r)=\mathbf{c}_{\text { light }_{0}} f_{\text { dist }}(r)
$$
其中 $f_\text{dist}$ 称为距离下降函数 distance falloff function。

#### 聚光灯 Spotlights

真实光源的光照会随着方向和距离变化，这种变化可以表达为一个方向下降函数 directional falloff function $f_\text{dir}(\mathbf{l})$和距离下降函数
$$
\mathbf{c}_{\text { light }}=\mathbf{c}_{\text { light }_{0}} f_{\text { dist }}(r) f_{\text { dir }}(1)
$$
不同的 $f_\text{dir}(\mathbf{l})$ 会产生不同的效果。其中一个重要的类型是聚光灯，在一个圆锥内投射光。

聚光灯的方向下降函数关于聚光灯方向向量 $\mathbf{s}$ 轴对称，因此可以表示为 $-\mathbf{l}$ 和 $\mathbf{s}$ 夹角的函数。

一般聚光灯的方向下降函数是一个窗口函数，大于本影角 umbra angle $\theta_u$ 时值为 0，小于半影角 penumbra angle $\theta_p$ 时值为 1，如下图所示

![1559831920525](assets/1559831920525.png)

方向下降函数的具体形式有多种，但大概相似。比如，Forstbite 的 $f_{\text{dir}_F}(\mathbf{l})$ 和 thress.js 的 $f_{\text{dir}_T}(\mathbf{l})$ 如下
$$
\begin{aligned} t &=\left(\frac{\cos \theta_{s}-\cos \theta_{u}}{\cos \theta_{p}-\cos \theta_{u}}\right)^{\mp} \\ f_{\operatorname{dir}_{\mathrm{F}}}(1) &=t^{2} \\ f_{\mathrm{dir}_{\mathrm{T}}}(1) &=\text { smoothstep }(t)=t^{2}(3-2 t) \end{aligned}
$$

#### Other Punctual Lights

$f_{\text{dir}}(\mathbf{l})$ 不只有聚光灯这一种。它可以表示任何类型的方向变化，包括从真实光源测量的复杂表格模式。

Illuminating Engineering Society (IES) 定义了这些测量的标准文件格式。

### 5.2.3 其他光源类型 Other Light Types

capsule light，用线段作为光源，着色时使用最近点来计算光源方向。

至今讨论的光源都是抽象的，在现实中光源具有形状和大小，会以多个方向照射表面点。在渲染中，这类光源称为 area light，实时应用中的使用越来越多。

## 5.3 实现着色模型 Implementing Shading Models

## 5.4 锯齿与抗锯齿 Aliasing and Antialiasing

## 5.5 Transparency. Alpha and Compositing

## 5.6 显示编码 Display Encoding