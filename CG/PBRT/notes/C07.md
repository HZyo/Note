# C07 采样和重建 Sampling and Reconstruction

[TOC]

虽然渲染器最终的输出是彩色像素组成的 2D 网格，但是 radiance 是定义在胶平面上的连续函数。

本章会介绍采样理论——从连续域上定义的函数中提取离散的采样值，然后使用这些采样重建与原始函数相似的新函数的理论。

## 7.1 采样理论 Sampling Theory

将一组样本值转换回连续函数的过程称为重构 reconstruction。

为了计算数字图像中的离散像素值，需要对原始连续定义的图像函数进行采样。

获得图像函数的信息的唯一方式是追踪光线。尽管在像素的精确位置采样就可以得到一张图像，但是通过在不同位置取更多的样本，并将这些关于图像函数的额外信息合并到最终像素值中，可以得到更好的结果。

由于采样和重建过程涉及到近似，它引入了称为混叠 aliasing 的错误，混叠可以以多种方式表现出来，包括锯齿状的边缘或动画中的闪烁。这些错误的发生是因为采样过程不能从连续定义的图像函数中捕获所有的信息。

> 示例
>
> ![1555572197959](assets/1555572197959.png)

傅里叶分析可用于评价重构函数与原函数匹配的质量。

### 7.1.1 The Frequency Domain and the Fourier Transform

傅里叶变换
$$
F ( \omega ) = \int _ { - \infty } ^ { \infty } f ( x ) \mathrm { e } ^ { - \mathrm { i } 2 \pi \omega x } \mathrm { d } x
$$
逆傅里叶变换
$$
f ( x ) = \int _ { - \infty } ^ { \infty } F ( \omega ) \mathrm { e } ^ { \mathrm { i } 2 \pi \omega x } \mathrm { d } \omega
$$

> 示例
>
> 空间域
>
> ![1556101867087](assets/1556101867087.png)
>
> 频域
>
> ![1556101889391](assets/1556101889391.png)

一些重要的函数及其傅里叶变换

| 空间域 Spatial Domain                             | 频率空间表示 Frequency Space Representation                  |
| ------------------------------------------------- | ------------------------------------------------------------ |
| Box: $f(x)=1$ if $|x|<1/2$, 0 otherwise           | Sinc: $f(\omega)=\text{sinc}(\pi\omega)/(\pi\omega)$         |
| Gaussian: $f(x)=e^{-\pi x^2}$                     | Gaussian: $f(\omega)=e^{-\pi\omega^2}$                       |
| Constant: $f(x)=1$                                | Delta: $f(\omega)=\delta(\omega)$                            |
| Sinusoid: $f (x) = \cos x$                        | Translared delta: $f(\omega)=\pi[\delta(1-2\pi\omega)+\delta(1+2\pi\omega)]$ |
| Shah: $f(x)={\bigsqcup}_T(x)=T\sum_i\delta(x-iT)$ | Shah: $f(\omega)=\bigsqcup_{1/T}(x)=(1/T)\sum_i\delta(\omega-i/T)$ |

Dirac delta 分布
$$
\begin{aligned}
\delta(x)&=0,x\ne 0\\
\int \delta ( x ) \mathrm { d } x &= 1\\
\int f ( x ) \delta ( x ) \mathrm { d } x &= f ( 0 )\\
\end{aligned}
$$

### 7.1.2 理想采样与重建 Ideal Sampling and Reconstruction

shah $\bigsqcup_T(x)$ 定义为
$$
{\bigsqcup}_T(x)=T\sum_{i=-\infty}^{+\infty}\delta(x-iT)
$$
我们可以通过将函数乘以 shah / 脉冲序列 函数完成采样
$$
{\bigsqcup}_T(x) f ( x ) = T \sum _ { i } \delta ( x - i T ) f ( i T )
$$

> 示例
>
> ![1556103192917](assets/1556103192917.png)

卷积 $\otimes$ 的定义为
$$
f ( x ) \otimes g ( x ) = \int _ { - \infty } ^ { \infty } f \left( x ^ { \prime } \right) g \left( x - x ^ { \prime } \right) d x ^ { \prime }
$$
通过选取一个重建过滤函数 $r(x)$，采样后的函数 ${\bigsqcup}_T(x) f ( x )$ 可以用来重建函数 $\tilde{f}$ 
$$
\begin{aligned}
\tilde{f}(x)
&= \left( {\bigsqcup}_T(x) f ( x ) \right) \otimes r ( x )\\
&= T \sum _ { i = - \infty } ^ { \infty } f ( i T ) r ( x - i T )\\
\end{aligned}
$$

> 示例
>
> 三角重建过滤器
>
> ![1556103665207](assets/1556103665207.png)

带限函数 $f(x)$ 是指存在频率 $\omega_0>0$，当 $|\omega|>\omega_0$ 时，$F(\omega)=0$。

傅里叶变换的卷积和乘机性质为
$$
\begin{aligned}
\mathcal { F } \{ f ( x ) g ( x ) \} &= F ( \omega ) \otimes G ( \omega )\\
\mathcal { F } \{ f ( x ) \otimes g ( x ) \} &= F ( \omega ) G ( \omega )\\
\end{aligned}
$$
此外，shah 函数 ${\bigsqcup}_T(x)$ 的傅里叶变换还是 shah 函数，只是周期从 T 变为了 $1/T$。这种互反关系很重要：采样越稀疏，频域越密集。

根据卷积性质，可以知道采样的信号就是 $F(x)$ 和 ${\bigsqcup}_{1/T}(x)$ 的卷积。一个函数与 delta 函数的卷积结果就是该函数的一个拷贝。那么与 shah 函数卷积结果就是原函数拷贝的无穷序列，间隔为 shah 函数的周期。

> 示例
>
> 原函数
>
> ![1556104917733](assets/1556104917733.png)
>
> 与 shah 函数的卷积
>
> ![1556104934524](assets/1556104934524.png)

现在有了原函数拷贝的无穷序列，就可以只保留中间的原函数拷贝，丢弃其他的，即可获得原信号。可以通过乘以一个 box 函数来实现该操作。

> 示例
>
> ![1556105384277](assets/1556105384277.png)

box 函数定义为
$$
\Pi _ { T } ( x ) = \left\{ \begin{array} { l l } { 1 / ( 2 T ) } & { | x | < T } \\ { 0 } & { \text { otherwise } } \end{array} \right.
$$
采样重建的整个过程总结如下
$$
\begin{aligned}
\tilde { F } (\omega) &= \left( F ( \omega ) \otimes {\bigsqcup}_{1/T}(x) \right) \Pi _ { T } ( \omega )\\

\tilde { f }
&= \left( f ( x ) {\bigsqcup}_{T}(x) \right) \otimes \operatorname { sinc } ( x )\\
&=\sum _ { i = - \infty } ^ { \infty } \operatorname { sinc } ( x - i T) f ( iT )\\
\end{aligned}
$$

### 7.1.3 混叠 Aliasing

采样理论要求信号是带限的。如果信号不是带限的，或者采样率过低，那么就会发生混叠。

> 示例
>
> ![1556106439797](assets/1556106439797.png)

对于带限信号，只要采样的频率 $\omega > 2\omega_0$ 就可完美重建信号。这个最小的频率 $2\omega_0$ 称为奈奎斯特频率 Nyquist frequency。

对于无带限的信号，再高的采样率也无法完美重建。

不幸的是，计算机图形学很少函数是带限的。

不连续的函数一定不是带限的。

### 7.1.4 反混淆技术 Antialiasing Techniques

首先区分采样和重建造成的 artifact。采样的 aritifact 是 prealiasing，重建的 artifact 是 postaliasing。解决这些的方法称为反混淆 antialiasing。

**Nonuniform Sampling** 

虽然我们所要采样的图像函数已知有无限的频率分量，因此不能从点样本中完美地重构，但是可以通过不均匀地改变样本之间的间距来减小混叠对视觉的影响。

用 $\xi$ 作为 0 - 1 的随机变量。非均匀样本集合的脉冲序列
$$
\sum _ { i = - \infty } ^ { \infty } \delta \left( x - \left( i + \frac { 1 } { 2 } - \xi \right) T \right)
$$
非均匀采样倾向于将规则的混淆转变为噪声，这不大会被人的视觉系统注意到。

**Adaptive Sampling** 

如果我们能够识别出频率高于奈奎斯特极限的信号区域，我们就可以在这些区域额外采样，而不需要增加各处采样频率的计算开销。

**Prefiltering** 

过滤(即(模糊)原始函数，这样就不会留下无法精确捕获的高频。

### 7.1.5 图像合成中的应用 Application to Image Synthesis

图像可以看成一个 2D 位置到 radiance 的函数
$$
f ( x , y ) \rightarrow L
$$
好消息是，用光线追踪器可以在任何点计函数值。坏消息是，通常不可能在采样前通过预过滤 f 来移除高频。因此采样器会增加采样率以及非均匀采样将混叠转换为噪声。

场景函数可以更加泛化为一个高位函数
$$
f \left( x , y , t , u , v , i _ { 1 } , i _ { 2 } , \ldots \right) \rightarrow L
$$
其中 $t$ 为时间，$(u,v)$ 是透镜上的位置，$i_1,i_2,\dots$ 是积分器要用到的样本值。

良好地采样所有这些维度是高效生成高质量图像的重要组成部分。

> 例如，如果我们确保图像上邻近的(x, y)位置在镜头上有不同的(u, v)位置，生成的渲染图像将有更小的误差，因为每个样本更有可能贡献相邻的样本没有的关于场景的信息。

### 7.1.6 渲染中混叠的来源 Sources of Aliasing in Rendering

物体投影到成像平面后，边界会引入阶跃函数。一方面阶跃函数有无限的频率，更糟的另一方面是 ringing artifacts。

> 示例
>
> ![1556109188570](assets/1556109188570.png)

另一个混叠的来源是物体的纹理和材质。还有 sharp shadow。

### 7.1.7 理解像素 Understanding Pixels

有两个很重要的概念

- 构成图像的像素是图像函数在图像平面上离散点处的点样，没有与像素相关联的“区域”。

- 最终图像中的像素自然定义为像素网格上的离散整数(x, y)坐标，但是本章中的采样器生成的图像样本位于连续浮点(x, y)位置。可以通过如下方式转换
  $$
  \begin{aligned}
  d &= \lfloor c \rfloor\\
  c &= d + 1 / 2\\
  \end{aligned}
  $$
  ![1556109759222](assets/1556109759222.png)

  这样离散范围 $[x_0,x_1]$ 对应的连续区域为 $[x_0,x_1+1)$。这样写出来的代码更简单些。

## 7.2 采样接口 Samping Interface

## *7.3 分层抽样 Stratified Sampling

## *7.4 Halton 采样器 Halton Sampler

## *7.5 (0, 2)-序列采样器 (0, 2)-Sequence Sampler

## *7.6 最大化最小距离采样器 Maximized Minimal Distance Sampler

## *7.7 Sobol’ 采样器 Sobol’ Sampler

## 7.8 图像重建 Image Reconstruction

## 7.9 胶片和成像管道 Film and the Imaging Pipeline